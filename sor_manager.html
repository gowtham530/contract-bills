<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>SOR Manager</title>

<!-- Firebase SDKs (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
// Firebase config (same)
const firebaseConfig = {
  apiKey: "AIzaSyBB8E1qDOs2rNr84xrlOoMWWZLtXXjZZbk",
  authDomain: "contract-bills.firebaseapp.com",
  projectId: "contract-bills",
  storageBucket: "contract-bills.firebasestorage.app",
  messagingSenderId: "935565138529",
  appId: "1:935565138529:web:ab847b0704ecdb4e746820",
  measurementId: "G-QT4FW1WGYB"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
</script>

<style>
  :root{--bg1:#071226;--bg2:#041827;--muted:#9fb0bf;--accent:#7dd3fc}
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;color:#eaf6f2;background:linear-gradient(180deg,var(--bg1),var(--bg2));padding:22px}
  .wrap{max-width:1100px;margin:0 auto;background:linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01));padding:18px;border-radius:12px;border:1px solid rgba(255,255,255,0.02)}
  h1{margin:0 0 14px 0;font-weight:900}
  .homeBtn{display:inline-block;margin:0;padding:6px 12px;border-radius:8px;background:linear-gradient(90deg,#7EE7C6,#B78CFF);color:#042b28;font-weight:700;text-decoration:none}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  thead th{ text-align:left;padding:10px 8px;color:var(--muted);font-size:0.85rem;border-bottom:1px solid rgba(255,255,255,0.03)}
  tbody td{padding:10px 8px;border-top:1px dashed rgba(255,255,255,0.02);vertical-align:top}
  input, select { padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.04); background:transparent;color:inherit }
  .actions{display:flex;gap:8px}
  .small{font-size:0.9rem;color:#bcd}

  /* Toasts */
  .toast-wrap{position:fixed;right:18px;bottom:18px;z-index:9999;display:flex;flex-direction:column;gap:8px;align-items:flex-end}
  .toast{min-width:220px;padding:10px 14px;border-radius:8px;background:rgba(0,0,0,0.8);color:#fff;box-shadow:0 6px 18px rgba(0,0,0,0.6);font-weight:700}
  .toast.success{background:linear-gradient(90deg,#7EE7C6,#38b29a);color:#042b28}
  .toast.error{background:linear-gradient(90deg,#ff7b7b,#ff4d4d);color:#200}
  .toast.info{background:linear-gradient(90deg,#7dd3fc,#4ca0d6);color:#042b28}
</style>
</head>
<body>
  <div class="wrap">
    <h1>SOR Manager</h1>
    <a href="index.html" class="homeBtn">← Home</a>

    <div style="margin-top:12px;margin-bottom:8px">
      <button id="addDepotBtn" class="homeBtn">Add Depot</button>
      <button id="saveAllBtn" class="homeBtn">Save All to Server</button>
    </div>

    <table id="sorTable">
      <thead>
        <tr><th>Depot Name</th><th>Agency</th><th>Unloading</th><th>Receipt10</th><th>Receipt16</th><th>Receipt20</th><th>Beyond20</th><th>Issues</th><th>Transport</th><th>ASOR</th><th>Supervision</th><th></th></tr>
      </thead>
      <tbody id="sorBody"><tr><td colspan="12" class="small">Loading…</td></tr></tbody>
    </table>

    <div style="margin-top:12px;color:#bcd;font-size:0.9rem">Notes: Use Save All to push the current table content to Firestore. Collection: <code>sor</code>.</div>
  </div>

  <div class="toast-wrap" id="toastWrap" aria-live="polite" aria-atomic="true"></div>

<script>
/* Toast */
function showToast(msg, type='info', timeout=3000){
  const wrap = document.getElementById('toastWrap');
  const t = document.createElement('div');
  t.className = 'toast ' + (type==='success' ? 'success' : type==='error' ? 'error' : 'info');
  t.textContent = msg;
  wrap.appendChild(t);
  setTimeout(()=>{ t.style.transition='opacity 300ms'; t.style.opacity='0'; setTimeout(()=>t.remove(),350); }, timeout);
}

function escapeHtml(s){ if(s==null) return ''; return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

/* Render from snapshot */
function renderSORFromDocs(docs){
  const body = document.getElementById('sorBody');
  body.innerHTML = '';
  if(!docs.length){ body.innerHTML = '<tr><td colspan="12" class="small">No depots</td></tr>'; return; }
  docs.forEach(d => {
    const tr = document.createElement('tr');
    tr.dataset.id = d.id || '';
    tr.innerHTML = `<td><input data-field="depotName" value="${escapeHtml(d.data().depotName||'')}" /></td>
      <td><input data-field="agency" value="${escapeHtml(d.data().agency||'')}" /></td>
      <td><input data-field="unloading" value="${d.data().unloading||''}" /></td>
      <td><input data-field="receipt10" value="${d.data().receipt10||''}" /></td>
      <td><input data-field="receipt16" value="${d.data().receipt16||''}" /></td>
      <td><input data-field="receipt20" value="${d.data().receipt20||''}" /></td>
      <td><input data-field="receiptBeyond" value="${d.data().receiptBeyond||''}" /></td>
      <td><input data-field="issues" value="${d.data().issues||''}" /></td>
      <td><input data-field="transportation" value="${d.data().transportation||''}" /></td>
      <td><input data-field="asor" value="${d.data().asor||''}" /></td>
      <td><input data-field="supervision" value="${d.data().supervision||''}" /></td>
      <td><button class="delBtn">Delete</button></td>`;
    body.appendChild(tr);
    tr.querySelector('.delBtn').addEventListener('click', ()=> tr.remove());
  });
}

/* Add a blank row for new depot */
function addBlankRow(){
  const body=document.getElementById('sorBody');
  const tr=document.createElement('tr');
  tr.innerHTML = `<td><input data-field="depotName" value="" /></td>
    <td><input data-field="agency" value="" /></td>
    <td><input data-field="unloading" value="" /></td>
    <td><input data-field="receipt10" value="" /></td>
    <td><input data-field="receipt16" value="" /></td>
    <td><input data-field="receipt20" value="" /></td>
    <td><input data-field="receiptBeyond" value="" /></td>
    <td><input data-field="issues" value="" /></td>
    <td><input data-field="transportation" value="" /></td>
    <td><input data-field="asor" value="" /></td>
    <td><input data-field="supervision" value="" /></td>
    <td><button class="delBtn">Delete</button></td>`;
  body.prepend(tr);
  tr.querySelector('.delBtn').addEventListener('click', ()=> tr.remove());
}

/* Optimistic Save All: replace server collection with current UI rows.
   Implementation: immediately show a saving toast, perform server replace batch,
   on success show success toast; on failure show error (UI table unchanged)
*/
async function saveAll(){
  const rows = Array.from(document.querySelectorAll('#sorBody tr'));
  const out = [];
  rows.forEach(tr => {
    const inputs = tr.querySelectorAll('input[data-field]');
    if(!inputs || inputs.length===0) return;
    const obj = {};
    inputs.forEach(inp => { const f = inp.getAttribute('data-field'); obj[f] = inp.value; });
    if((obj.depotName||'').trim()) out.push(obj);
  });
  if(out.length===0){ showToast('Nothing to save', 'info'); return; }
  showToast('Saving SOR to server…', 'info', 3000);
  try{
    // delete existing then add new
    const col = db.collection('sor');
    const existing = await col.get();
    const batch = db.batch();
    existing.forEach(doc => batch.delete(doc.ref));
    await batch.commit();
    const batch2 = db.batch();
    out.forEach(item=>{
      const ref = col.doc();
      batch2.set(ref, item);
    });
    await batch2.commit();
    showToast('SOR saved to server', 'success');
  }catch(e){
    console.error(e);
    showToast('Save failed: ' + (e.message||'network error'), 'error', 5000);
  }
}

/* Realtime listener: render when collection changes */
let sorUnsub = null;
function startSorRealtime(){
  if(sorUnsub) sorUnsub();
  sorUnsub = db.collection('sor').orderBy('depotName').onSnapshot(snapshot => {
    renderSORFromDocs(snapshot.docs);
    showToast('SOR updated', 'info', 1200);
  }, err => { console.error('sor onSnapshot err', err); showToast('Realtime SOR error', 'error'); });
}

/* Init */
document.addEventListener('DOMContentLoaded', async ()=>{
  document.getElementById('addDepotBtn').addEventListener('click', addBlankRow);
  document.getElementById('saveAllBtn').addEventListener('click', saveAll);
  startSorRealtime();
});
</script>
</body>
</html>
