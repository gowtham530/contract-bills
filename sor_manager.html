<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>SOR Manager</title>

<!-- Firebase SDKs (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
// Firebase config (same)
const firebaseConfig = {
  apiKey: "AIzaSyBB8E1qDOs2rNr84xrlOoMWWZLtXXjZZbk",
  authDomain: "contract-bills.firebaseapp.com",
  projectId: "contract-bills",
  storageBucket: "contract-bills.firebasestorage.app",
  messagingSenderId: "935565138529",
  appId: "1:935565138529:web:ab847b0704ecdb4e746820",
  measurementId: "G-QT4FW1WGYB"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
</script>

<style>
  :root{--bg1:#071226;--bg2:#041827;--muted:#9fb0bf;--accent:#7dd3fc}
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;color:#eaf6f2;background:linear-gradient(180deg,var(--bg1),var(--bg2));padding:22px}
  .wrap{max-width:1100px;margin:0 auto;background:linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01));padding:18px;border-radius:12px;border:1px solid rgba(255,255,255,0.02)}
  h1{margin:0 0 14px 0;font-weight:900}
  .homeBtn{display:inline-block;margin:0;padding:6px 12px;border-radius:8px;background:linear-gradient(90deg,#7EE7C6,#B78CFF);color:#042b28;font-weight:700;text-decoration:none}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  thead th{ text-align:left;padding:10px 8px;color:var(--muted);font-size:0.85rem;border-bottom:1px solid rgba(255,255,255,0.03)}
  tbody td{padding:10px 8px;border-top:1px dashed rgba(255,255,255,0.02);vertical-align:top}
  input, select { padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.04); background:transparent;color:inherit }
  .actions{display:flex;gap:8px}
  .small{font-size:0.9rem;color:#bcd}
  .row-actions{display:flex;gap:6px}
  .btn-row{padding:6px 8px;border-radius:6px;border:0;cursor:pointer;font-weight:700}
  .btn-edit{background:linear-gradient(90deg,#7dd3fc,#4ca0d6);color:#042b28}
  .btn-save{background:linear-gradient(90deg,#7EE7C6,#38b29a);color:#042b28}
  .btn-del{background:linear-gradient(90deg,#ff8a8a,#ff4d4d);color:#200}
  .readonly input{background:transparent;border-color:transparent;color:#bcd}
  .editable input{background:rgba(255,255,255,0.03);border-color:rgba(255,255,255,0.08);color:#eaf6f2}
  /* Toasts */
  .toast-wrap{position:fixed;right:18px;bottom:18px;z-index:9999;display:flex;flex-direction:column;gap:8px;align-items:flex-end}
  .toast{min-width:220px;padding:10px 14px;border-radius:8px;background:rgba(0,0,0,0.8);color:#fff;box-shadow:0 6px 18px rgba(0,0,0,0.6);font-weight:700}
  .toast.success{background:linear-gradient(90deg,#7EE7C6,#38b29a);color:#042b28}
  .toast.error{background:linear-gradient(90deg,#ff7b7b,#ff4d4d);color:#200}
  .toast.info{background:linear-gradient(90deg,#7dd3fc,#4ca0d6);color:#042b28}
</style>
</head>
<body>
  <div class="wrap">
    <h1>SOR Manager</h1>
    <a href="index.html" class="homeBtn">← Home</a>

    <div style="margin-top:12px;margin-bottom:8px">
      <button id="addDepotBtn" class="homeBtn">Add Depot</button>
      <button id="saveAllBtn" class="homeBtn">Save All to Server</button>
    </div>

    <table id="sorTable" role="grid" aria-label="SOR Manager">
      <thead>
        <tr><th>Depot Name</th><th>Agency</th><th>Unloading</th><th>Receipt10</th><th>Receipt16</th><th>Receipt20</th><th>Beyond20</th><th>Issues</th><th>Transport</th><th>ASOR</th><th>Supervision</th><th>Actions</th></tr>
      </thead>
      <tbody id="sorBody"><tr><td colspan="12" class="small">Loading…</td></tr></tbody>
    </table>

    <div style="margin-top:12px;color:#bcd;font-size:0.9rem">Notes: Use Save All to push the current table content to Firestore. You can edit individual rows by tapping Edit then Save.</div>
  </div>

  <div class="toast-wrap" id="toastWrap" aria-live="polite" aria-atomic="true"></div>

<script>
/* Toast */
function showToast(msg, type='info', timeout=3000){
  const wrap = document.getElementById('toastWrap');
  const t = document.createElement('div');
  t.className = 'toast ' + (type==='success' ? 'success' : type==='error' ? 'error' : 'info');
  t.textContent = msg;
  wrap.appendChild(t);
  setTimeout(()=>{ t.style.transition='opacity 300ms'; t.style.opacity='0'; setTimeout(()=>t.remove(),350); }, timeout);
}

function escapeHtml(s){ if(s==null) return ''; return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

/* Firestore helpers */
async function fetchSORFromServer(){
  const snap = await db.collection('sor').orderBy('depotName').get();
  const arr = [];
  snap.forEach(doc => { const d = doc.data(); d._id = doc.id; arr.push(d); });
  return arr;
}

/* Update one doc (merge) */
async function updateSORRow(id, obj){
  if(!id){ // create new
    obj.createdAt = new Date().toISOString();
    const ref = await db.collection('sor').add(obj);
    return ref.id;
  } else {
    await db.collection('sor').doc(id).set(obj, {merge:true});
    return id;
  }
}

/* Replace entire collection (existing Save All behavior) */
async function saveAllToServer(sorArray){
  const col = db.collection('sor');
  const existing = await col.get();
  const batch = db.batch();
  existing.forEach(doc => batch.delete(doc.ref));
  await batch.commit();
  const batch2 = db.batch();
  sorArray.forEach(item => {
    const ref = col.doc();
    batch2.set(ref, item);
  });
  await batch2.commit();
}

/* Render rows from docs snapshot */
function renderSORFromDocs(docs){
  const body = document.getElementById('sorBody');
  body.innerHTML = '';
  if(!docs.length){ body.innerHTML = '<tr><td colspan="12" class="small">No depots</td></tr>'; return; }

  docs.forEach(d => {
    const data = d.data();
    const id = d.id;
    const tr = document.createElement('tr');
    tr.dataset.id = id;

    // Row HTML: inputs are readonly by default (for existing docs)
    tr.innerHTML = `<td class="cell-depot readonly"><input data-field="depotName" value="${escapeHtml(data.depotName||'')}" readonly /></td>
      <td class="cell-agency readonly"><input data-field="agency" value="${escapeHtml(data.agency||'')}" readonly /></td>
      <td class="cell-unloading readonly"><input data-field="unloading" value="${data.unloading||''}" readonly /></td>
      <td class="cell-r10 readonly"><input data-field="receipt10" value="${data.receipt10||''}" readonly /></td>
      <td class="cell-r16 readonly"><input data-field="receipt16" value="${data.receipt16||''}" readonly /></td>
      <td class="cell-r20 readonly"><input data-field="receipt20" value="${data.receipt20||''}" readonly /></td>
      <td class="cell-b20 readonly"><input data-field="receiptBeyond" value="${data.receiptBeyond||''}" readonly /></td>
      <td class="cell-issues readonly"><input data-field="issues" value="${data.issues||''}" readonly /></td>
      <td class="cell-trans readonly"><input data-field="transportation" value="${data.transportation||''}" readonly /></td>
      <td class="cell-asor readonly"><input data-field="asor" value="${data.asor||''}" readonly /></td>
      <td class="cell-sup readonly"><input data-field="supervision" value="${data.supervision||''}" readonly /></td>
      <td class="row-actions">
        <button class="btn-row btn-edit" title="Edit row">Edit</button>
        <button class="btn-row btn-save" style="display:none" title="Save changes">Save</button>
        <button class="btn-row btn-del" title="Delete row">Delete</button>
      </td>`;

    body.appendChild(tr);

    // wire up row buttons
    const btnEdit = tr.querySelector('.btn-edit');
    const btnSave = tr.querySelector('.btn-save');
    const btnDel  = tr.querySelector('.btn-del');

    // make inputs easier to get
    const inputs = tr.querySelectorAll('input[data-field]');

    // Edit: enable inputs for this row only
    btnEdit.addEventListener('click', () => {
      // set row to editable style
      tr.classList.remove('readonly'); tr.classList.add('editable');
      // make inputs editable
      inputs.forEach(inp => { inp.removeAttribute('readonly'); inp.focus(); });
      btnEdit.style.display = 'none';
      btnSave.style.display = 'inline-block';
    });

    // Save: collect values and write single doc to server
    btnSave.addEventListener('click', async () => {
      // gather values
      const obj = {};
      inputs.forEach(inp => obj[inp.getAttribute('data-field')] = inp.value);
      // basic validation: depotName required
      if(!(obj.depotName || '').trim()){ showToast('Depot Name required', 'error'); return; }
      // optimistic UI: mark row as saving
      tr.style.opacity = '0.6';
      showToast('Saving row…', 'info', 2000);
      try{
        const newId = await updateSORRow(id, obj);
        // if this was a new created id (shouldn't happen here, existing row), ensure dataset id is set
        tr.dataset.id = newId;
        showToast('Row saved', 'success');
      }catch(e){
        console.error(e);
        showToast('Save failed: ' + (e.message || 'network error'), 'error', 4000);
      }finally{
        tr.style.opacity = '';
        // switch back to readonly
        inputs.forEach(inp => inp.setAttribute('readonly','true'));
        tr.classList.remove('editable'); tr.classList.add('readonly');
        btnEdit.style.display = 'inline-block';
        btnSave.style.display = 'none';
      }
    });

    // Delete: remove doc from server (ask confirm)
    btnDel.addEventListener('click', async ()=>{
      if(!confirm('Delete this depot permanently?')) return;
      try{
        await db.collection('sor').doc(id).delete();
        showToast('Depot deleted', 'success');
      }catch(e){ console.error(e); showToast('Delete failed', 'error'); }
    });
  });
}

/* Add blank row (editable) - not coming from server yet */
function addBlankRow(){
  const body = document.getElementById('sorBody');
  const tr = document.createElement('tr');
  tr.dataset.id = ''; // no id yet
  tr.classList.add('editable');
  tr.innerHTML = `<td class="cell-depot"><input data-field="depotName" value="" /></td>
    <td class="cell-agency"><input data-field="agency" value="" /></td>
    <td class="cell-unloading"><input data-field="unloading" value="" /></td>
    <td class="cell-r10"><input data-field="receipt10" value="" /></td>
    <td class="cell-r16"><input data-field="receipt16" value="" /></td>
    <td class="cell-r20"><input data-field="receipt20" value="" /></td>
    <td class="cell-b20"><input data-field="receiptBeyond" value="" /></td>
    <td class="cell-issues"><input data-field="issues" value="" /></td>
    <td class="cell-trans"><input data-field="transportation" value="" /></td>
    <td class="cell-asor"><input data-field="asor" value="" /></td>
    <td class="cell-sup"><input data-field="supervision" value="" /></td>
    <td class="row-actions">
      <button class="btn-row btn-save" title="Save new row">Save</button>
      <button class="btn-row btn-del" title="Delete row">Delete</button>
    </td>`;
  body.prepend(tr);

  const btnSave = tr.querySelector('.btn-save');
  const btnDel  = tr.querySelector('.btn-del');
  const inputs = tr.querySelectorAll('input[data-field]');

  // Save new row (create doc)
  btnSave.addEventListener('click', async ()=>{
    const obj = {};
    inputs.forEach(inp => obj[inp.getAttribute('data-field')] = inp.value);
    if(!(obj.depotName||'').trim()){ showToast('Depot Name required', 'error'); return; }
    tr.style.opacity = '0.6';
    showToast('Creating depot…', 'info', 2000);
    try{
      const ref = await db.collection('sor').add(obj);
      showToast('Depot created', 'success');
      // set dataset id and convert to readonly row
      tr.dataset.id = ref.id;
      inputs.forEach(inp => inp.setAttribute('readonly','true'));
      tr.classList.remove('editable'); tr.classList.add('readonly');
      // replace Save button with Edit + Delete
      const actionCell = tr.querySelector('.row-actions');
      actionCell.innerHTML = '';
      const btnEdit = document.createElement('button'); btnEdit.className='btn-row btn-edit'; btnEdit.textContent='Edit';
      const btnSave2 = document.createElement('button'); btnSave2.className='btn-row btn-save'; btnSave2.style.display='none'; btnSave2.textContent='Save';
      const btnDel2 = document.createElement('button'); btnDel2.className='btn-row btn-del'; btnDel2.textContent='Delete';
      actionCell.appendChild(btnEdit); actionCell.appendChild(btnSave2); actionCell.appendChild(btnDel2);
      // wire events similar to existing rows
      btnEdit.addEventListener('click', ()=>{
        tr.classList.remove('readonly'); tr.classList.add('editable');
        inputs.forEach(inp => { inp.removeAttribute('readonly'); inp.focus(); });
        btnEdit.style.display='none'; btnSave2.style.display='inline-block';
      });
      btnSave2.addEventListener('click', async ()=>{
        const obj2 = {}; inputs.forEach(inp => obj2[inp.getAttribute('data-field')] = inp.value);
        if(!(obj2.depotName||'').trim()){ showToast('Depot Name required', 'error'); return; }
        tr.style.opacity = '0.6';
        showToast('Saving row…', 'info', 2000);
        try{
          await db.collection('sor').doc(ref.id).set(obj2, {merge:true});
          showToast('Row saved', 'success');
        }catch(e){ console.error(e); showToast('Save failed', 'error'); }
        tr.style.opacity=''; inputs.forEach(inp => inp.setAttribute('readonly','true')); tr.classList.remove('editable'); tr.classList.add('readonly');
        btnEdit.style.display='inline-block'; btnSave2.style.display='none';
      });
      btnDel2.addEventListener('click', async ()=>{
        if(!confirm('Delete this depot permanently?')) return;
        try{ await db.collection('sor').doc(ref.id).delete(); showToast('Depot deleted', 'success'); }catch(e){ showToast('Delete failed', 'error'); }
      });
    }catch(e){
      console.error(e); showToast('Create failed: ' + (e.message || 'network error'), 'error');
      tr.style.opacity='';
    }
  });

  // Delete blank row (client-side) before it is saved
  btnDel.addEventListener('click', ()=>{
    if(!confirm('Remove this new row?')) return;
    tr.remove();
  });
}

/* Save all table rows (replace collection) - keep for bulk updates */
async function saveAll(){
  const rows = Array.from(document.querySelectorAll('#sorBody tr'));
  const out = [];
  rows.forEach(tr => {
    const inputs = tr.querySelectorAll('input[data-field]');
    if(!inputs || inputs.length===0) return;
    const obj = {};
    inputs.forEach(inp => { const f = inp.getAttribute('data-field'); obj[f] = inp.value; });
    if((obj.depotName||'').trim()) out.push(obj);
  });
  if(out.length===0){ showToast('Nothing to save', 'info'); return; }
  showToast('Saving all SOR to server…', 'info', 2000);
  try{
    await saveAllToServer(out);
    showToast('All SOR saved', 'success');
  }catch(e){
    console.error(e); showToast('Save All failed: ' + (e.message||'network error'), 'error');
  }
}

/* Realtime: listen to sor collection and render rows */
let sorUnsub = null;
function startSorRealtime(){
  if(sorUnsub) sorUnsub();
  sorUnsub = db.collection('sor').orderBy('depotName').onSnapshot(snapshot => {
    renderSORFromDocs(snapshot.docs);
  }, err => { console.error('sor onSnapshot err', err); showToast('Realtime SOR error', 'error'); });
}

/* Init */
document.addEventListener('DOMContentLoaded', async ()=>{
  document.getElementById('addDepotBtn').addEventListener('click', addBlankRow);
  document.getElementById('saveAllBtn').addEventListener('click', saveAll);
  startSorRealtime();
});
</script>
</body>
</html>
