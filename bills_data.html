<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Bills Data — Management</title>

<!-- Firebase SDKs (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
// Firebase config (same)
const firebaseConfig = {
  apiKey: "AIzaSyBB8E1qDOs2rNr84xrlOoMWWZLtXXjZZbk",
  authDomain: "contract-bills.firebaseapp.com",
  projectId: "contract-bills",
  storageBucket: "contract-bills.firebasestorage.app",
  messagingSenderId: "935565138529",
  appId: "1:935565138529:web:ab847b0704ecdb4e746820",
  measurementId: "G-QT4FW1WGYB"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
</script>

<style>
  :root{--bg1:#071226;--bg2:#041827;--muted:#9fb0bf;--accent:#7dd3fc}
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;color:#eaf6f2;background:linear-gradient(180deg,var(--bg1),var(--bg2));padding:22px}
  .wrap{max-width:1200px;margin:0 auto;background:linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01));padding:18px;border-radius:12px;border:1px solid rgba(255,255,255,0.02)}
  h1{margin:0 0 14px 0;font-weight:900}
  .toolbar{display:flex;gap:8px;align-items:center;margin-bottom:12px}
  .homeBtn{display:inline-block;margin:0;padding:6px 12px;border-radius:8px;background:linear-gradient(90deg,#7EE7C6,#B78CFF);color:#042b28;font-weight:700;text-decoration:none}
  input[type="search"]{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  thead th{ text-align:left;padding:10px 8px;color:var(--muted);font-size:0.85rem;border-bottom:1px solid rgba(255,255,255,0.03)}
  tbody td{padding:10px 8px;border-top:1px dashed rgba(255,255,255,0.02);vertical-align:top}
  tr.clickable-row{cursor:pointer}
  .small{font-size:0.9rem;color:var(--muted)}
  .btn{padding:6px 10px;border-radius:6px;border:0;cursor:pointer;font-weight:700}
  .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--accent)}
</style>
</head>
<body>
  <div class="wrap">
    <h1>Bills Data — Management</h1>

    <div class="toolbar">
      <a href="index.html" class="homeBtn">← Home</a>
      <div style="margin-left:10px;">
        <label class="small" style="margin-right:6px">Search:</label>
        <input id="searchText" type="search" placeholder="Bill no or depot" />
      </div>
      <div style="margin-left:auto">
        <button id="exportCsv" class="btn btn-ghost">Export CSV</button>
        <button id="exportJson" class="btn btn-ghost">Export JSON</button>
      </div>
    </div>

    <table id="billsTable" aria-live="polite">
      <thead>
        <tr>
          <th style="width:48px">#</th>
          <th>Bill No</th>
          <th>Depot</th>
          <th>Saved At</th>
          <th style="text-align:right">Nett</th>
        </tr>
      </thead>
      <tbody id="billsBody">
        <tr><td colspan="5" class="small">Loading…</td></tr>
      </tbody>
    </table>
  </div>

<script>
function amountDisplay(v){ const n = Number(String(v||0).replace(/,/g,'')); return isFinite(n)?n.toFixed(2):'0.00'; }
function fmtDate(iso){ if(!iso) return '—'; try { return new Date(iso).toLocaleString(); } catch(e){ return iso; } }

async function fetchBillsFromServer(){
  const snap = await db.collection('bills').orderBy('savedAt','desc').get();
  const arr = [];
  snap.forEach(doc => { const d = doc.data(); d._id = doc.id; arr.push(d); });
  return arr;
}

async function renderList(){
  const all = await fetchBillsFromServer();
  const q = (document.getElementById('searchText').value || '').toLowerCase().trim();
  const body = document.getElementById('billsBody');
  body.innerHTML = '';
  const filtered = all.filter(b => {
    if(!q) return true;
    return (String(b.A2||'') + ' ' + String(b.A1||'') + ' ' + String(b.A46||'')).toLowerCase().includes(q);
  });
  if(filtered.length===0){ body.innerHTML = '<tr><td colspan="5" class="small">No bills found</td></tr>'; return; }
  filtered.forEach((b,i)=>{
    const tr = document.createElement('tr'); tr.className='clickable-row';
    tr.dataset.idx = i;
    tr.innerHTML = `<td>${i+1}</td>
      <td style="font-weight:700">${escapeHtml(b.A2||'—')}</td>
      <td>${escapeHtml(b.A1||'—')}</td>
      <td class="small">${fmtDate(b.savedAt||'')}</td>
      <td style="text-align:right">₹ ${amountDisplay(b.A46)}</td>`;
    tr.addEventListener('click', ()=> {
      localStorage.setItem('bill_to_open', JSON.stringify({_id: b._id}));
      window.location.href = 'bills_calc.html';
    });
    body.appendChild(tr);
  });
}

function escapeHtml(s){ if(s==null) return ''; return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

document.getElementById('searchText').addEventListener('input', renderList);
document.getElementById('exportCsv').addEventListener('click', async ()=>{
  const arr = await fetchBillsFromServer();
  if(!arr.length){ alert('No bills to export'); return; }
  const keys = Array.from(new Set(arr.flatMap(o => Object.keys(o)))).sort();
  const header = keys.join(',');
  const lines = arr.map(row => keys.map(k => `"${String(row[k]||'').replace(/"/g,'""')}"`).join(','));
  const csv = [header].concat(lines).join('\n');
  const blob = new Blob([csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'bills_export.csv'; a.click(); URL.revokeObjectURL(url);
});
document.getElementById('exportJson').addEventListener('click', async ()=>{
  const arr = await fetchBillsFromServer();
  if(!arr.length){ alert('No bills to export'); return; }
  const blob = new Blob([JSON.stringify(arr, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'bills_export.json'; a.click(); URL.revokeObjectURL(url);
});

document.addEventListener('DOMContentLoaded', renderList);

// Realtime update: refresh when the remote collection changes
db.collection('bills').onSnapshot(() => { renderList(); });
</script>
</body>
</html>
